document.addEventListener('DOMContentLoaded', () => {
    const JSONBIN_URL = 'https://api.jsonbin.io/v3/b/6891a251f7e7a370d1f41a77';
    const JSONBIN_API_KEY = '$2a$10$sOSZ5D6cVDPPwJUTty/w0uvrbNINyCukvfWIeW2bv4BhXiQe8jwym';

    let promotions = [];
    let currentDate = new Date('2025-08-01T00:00:00Z');
    let charts = {};

    // config, categories, icons...
    const competitors = ['Courts','Harvey Norman','Gain City'];
    const competitorConfig = { /*...*/ };
    const promoCategories = [ /*...*/ ];
    const categoryColors = { /*...*/ };
    const categoryIcons = { /*... SVG strings ...*/ };

    // utility, API, render, event handlers, notifications
    async function loadPromotions() { /* ... full code copied ... */ }
    async function saveData(updatedPromotions){ /* ... */ }

    const handleAddPromoForm = async (event) => { /* ... */ };
    const handleEditPromoForm = async (event) => { /* ... */ };
    const deletePromotion = async (promoId) => { /* ... */ };

    const createTimeline = () => { /* ... */ };
    const generateCustomLegend = (chart, containerId) => { /* ... */ };
    const renderDashboard = (activePromos) => { /* ... */ };
    const renderPromotionCards = (activePromos) => { /* ... */ };
    const rerenderAll = () => { /* ... */ };

    const showPromoDetailsModal = (promoId) => { /* ... */ };
    const showDeleteConfirmModal = (promoId) => { /* ... */ };
    const showEditPromoModal = (promoId) => { /* ... */ };
    const populateDropdowns = () => { /* ... */ };
    const showNotification = (message, colorClass='bg-green-500') => { /* ... */ };
    const updateLastUpdatedText = () => { /* ... */ };

    // init
    populateDropdowns();
    document.getElementById('openAddPromoModalBtn').addEventListener('click', () => { document.getElementById('addPromoModal').classList.remove('hidden'); });
    document.getElementById('addPromoForm').addEventListener('submit', handleAddPromoForm);
    document.getElementById('editPromoForm').addEventListener('submit', handleEditPromoForm);
    document.getElementById('cancelDeleteBtn').addEventListener('click', ()=>{ document.getElementById('deleteConfirmModal').classList.add('hidden'); });
    document.getElementById('confirmDeleteBtn').addEventListener('click', (e)=>{ const promoId=parseInt(e.currentTarget.dataset.promoId); deletePromotion(promoId); });
    document.getElementById('prev-month-btn').addEventListener('click', ()=>{ currentDate.setUTCMonth(currentDate.getUTCMonth()-1,1); rerenderAll(); });
    document.getElementById('next-month-btn').addEventListener('click', ()=>{ currentDate.setUTCMonth(currentDate.getUTCMonth()+1,1); rerenderAll(); });

    loadPromotions();
});
